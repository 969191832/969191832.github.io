<!-- START OF FILE 51_StackMem.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>51单片机 堆栈(Stack)原理</title>
    <style>
        :root { --bg:#121212; --cell:#252525; --active:#4caf50; --sp:#ff9800; }
        body { background:var(--bg); color:#eee; font-family:monospace; display:flex; height:100vh; margin:0; }
        
        .control-panel { width:250px; background:#1e1e1e; padding:20px; display:flex; flex-direction:column; gap:10px; }
        h2 { color:var(--sp); margin-top:0; }
        
        .ram-view { flex:1; display:flex; justify-content:center; align-items:center; overflow:auto; }
        .memory-ladder { display:flex; flex-direction:column-reverse; gap:2px; } /* Stack visual grows up */
        
        .mem-cell {
            width: 200px; height: 40px; background: var(--cell);
            border: 1px solid #444; display: flex; align-items: center; padding: 0 10px;
            position: relative; transition: background 0.3s;
        }
        .mem-addr { color:#888; width: 50px; }
        .mem-val { color:#fff; font-weight:bold; flex:1; text-align:center; }
        
        /* SP 指针 */
        .sp-arrow {
            position: absolute; right: -60px; color: var(--sp); font-weight:bold;
            transition: top 0.3s; display: flex; align-items: center;
        }
        .sp-arrow::before { content:"← SP"; margin-left:5px; }
        
        .reg-display { background:#333; padding:10px; border-radius:5px; margin-bottom:10px; }
        button { padding:10px; cursor:pointer; background:#444; color:#fff; border:none; border-radius:4px; font-weight:bold;}
        button:hover { background:var(--active); }
        
        .highlight { background:#388e3c !important; }
    </style>
</head>
<body>

<div class="control-panel">
    <h2>堆栈演示</h2>
    <div class="reg-display">
        <div>ACC: <span id="val-acc" style="color:#4caf50">0xAA</span></div>
        <div>B: <span id="val-b" style="color:#2196f3">0xBB</span></div>
    </div>
    <div class="reg-display">
        <div>SP (Stack Pointer)</div>
        <div id="val-sp" style="font-size:1.5em; color:var(--sp)">07H</div>
    </div>
    
    <button onclick="pushOp('ACC')">PUSH ACC</button>
    <button onclick="pushOp('B')">PUSH B</button>
    <div style="height:10px"></div>
    <button onclick="popOp('ACC')">POP ACC</button>
    <button onclick="popOp('B')">POP B</button>
    <button onclick="reset()" style="margin-top:20px; background:#f44336;">Reset</button>
    
    <div style="font-size:12px; color:#aaa; margin-top:10px;">
        51单片机堆栈<br>
        <strong>向上生长</strong> (地址变大)<br>
        PUSH: SP+1 -> 存数据<br>
        POP: 取数据 -> SP-1
    </div>
</div>

<div class="ram-view">
    <div class="memory-ladder" id="mem-container">
        <!-- Cells generated by JS -->
    </div>
</div>

<script>
    let SP = 0x07;
    const RAM = new Array(128).fill(0);
    const REGS = { ACC: 0xAA, B: 0xBB };

    // Init RAM view range (0x00 to 0x0F is enough for demo)
    const viewStart = 0x00;
    const viewEnd = 0x0E;

    function render() {
        const container = document.getElementById('mem-container');
        container.innerHTML = '';
        
        for(let i=viewStart; i<=viewEnd; i++) {
            const cell = document.createElement('div');
            cell.className = 'mem-cell';
            cell.id = `mem-${i}`;
            
            // Address
            const addrDiv = document.createElement('div');
            addrDiv.className = 'mem-addr';
            addrDiv.innerText = i.toString(16).toUpperCase().padStart(2,'0') + 'H';
            
            // Value
            const valDiv = document.createElement('div');
            valDiv.className = 'mem-val';
            const valHex = RAM[i].toString(16).toUpperCase().padStart(2,'0');
            valDiv.innerText = valHex;
            if(RAM[i] !== 0) valDiv.style.color = "#fff";
            else valDiv.style.color = "#444";

            cell.appendChild(addrDiv);
            cell.appendChild(valDiv);

            // SP Arrow
            if (i === SP) {
                const arrow = document.createElement('div');
                arrow.className = 'sp-arrow';
                cell.appendChild(arrow);
                cell.style.borderColor = "var(--sp)";
            }
            
            container.appendChild(cell);
        }
        
        document.getElementById('val-sp').innerText = SP.toString(16).toUpperCase().padStart(2,'0') + 'H';
        document.getElementById('val-acc').innerText = '0x' + REGS.ACC.toString(16).toUpperCase();
        document.getElementById('val-b').innerText = '0x' + REGS.B.toString(16).toUpperCase();
    }

    function pushOp(regName) {
        if(SP >= viewEnd) return alert("Stack Overflow for Demo!");
        
        // 1. SP++
        SP++;
        
        // 2. Write Data
        const val = REGS[regName];
        RAM[SP] = val;
        
        render();
        highlightCell(SP);
    }

    function popOp(regName) {
        if(SP <= 0x07) return alert("Stack Empty (SP=07H)");
        
        // 1. Read Data
        const val = RAM[SP];
        // Clean up visual (optional, real RAM retains data but we clear for clarity)
        RAM[SP] = 0; 
        
        // 2. SP--
        SP--;
        
        // Update Reg
        REGS[regName] = val;
        
        render();
    }

    function highlightCell(idx) {
        const cell = document.getElementById(`mem-${idx}`);
        if(cell) {
            cell.classList.add('highlight');
            setTimeout(() => cell.classList.remove('highlight'), 300);
        }
    }

    function reset() {
        SP = 0x07;
        for(let i=0; i<RAM.length; i++) RAM[i] = 0;
        REGS.ACC = 0xAA;
        REGS.B = 0xBB;
        render();
    }

    render();
</script>
</body>
</html>