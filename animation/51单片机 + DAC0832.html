<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>51å•ç‰‡æœºæ‰©å±• DAC0832 åŸç†æ¼”ç¤º</title>
    <style>
        :root {
            --bg-color: #1e1e24;
            --panel-bg: #2b2b35;
            --accent-color: #4caf50;
            --text-color: #e0e0e0;
            --wire-color: #555;
            --wire-active: #00ff00;
            --led-off: #333;
            --led-on: #ff3333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background-color: #15151a;
            padding: 10px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 1.2rem; }
        .badge { background: var(--accent-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }

        /* Main Layout */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar Controls */
        .sidebar {
            width: 300px;
            background-color: var(--panel-bg);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .control-group {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .control-group h3 { margin-top: 0; font-size: 1rem; color: var(--accent-color); }

        label { display: block; margin-bottom: 8px; font-size: 0.9rem; }
        
        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .value-display {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            color: #00e5ff;
            float: right;
        }

        button {
            background-color: #444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 5px;
            transition: 0.2s;
        }

        button:hover { background-color: #555; }
        button.active { background-color: var(--accent-color); }

        /* Visualization Area */
        .demo-area {
            flex: 1;
            position: relative;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            flex-direction: column;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Bottom Info Panel */
        .info-panel {
            height: 180px;
            background-color: #15151a;
            border-top: 1px solid var(--accent-color);
            padding: 15px 30px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .info-panel h3 { color: var(--accent-color); margin-top: 0; }
        .info-panel ul { padding-left: 20px; }
        .info-panel li { margin-bottom: 5px; }
        code { background: #333; padding: 2px 4px; border-radius: 3px; font-family: monospace; color: #ff9800; }

        /* Overlay UI elements on Canvas */
        .overlay-stats {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            font-family: monospace;
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>CodeMaster å®éªŒå®¤: 51å•ç‰‡æœº + DAC0832</h1>
    </div>
    <span class="badge">Interactive Demo</span>
</header>

<div class="container">
    <!-- Left Panel: Controls -->
    <div class="sidebar">
        <div class="control-group">
            <h3>è¾“å…¥æ§åˆ¶ (P0ç«¯å£)</h3>
            <label>æ•°å­—é‡ (0-255) <span id="digitalVal" class="value-display">128</span></label>
            <input type="range" id="inputSlider" min="0" max="255" value="128">
            <div style="margin-top: 10px; display: flex; gap: 5px;">
                <div id="bits-display" style="display: flex; gap: 2px; width: 100%; justify-content: center;">
                    <!-- Bits will be generated by JS -->
                </div>
            </div>
        </div>

        <div class="control-group">
            <h3>å‚æ•°è®¾ç½®</h3>
            <label>å‚è€ƒç”µå‹ Vref (V) <span id="vrefVal" class="value-display">5.0</span></label>
            <input type="range" id="vrefSlider" min="1" max="10" step="0.1" value="5.0">
        </div>

        <div class="control-group">
            <h3>è‡ªåŠ¨æ¼”ç¤ºæ¨¡å¼</h3>
            <button onclick="setMode('manual')" id="btn-manual" class="active">æ‰‹åŠ¨è°ƒèŠ‚</button>
            <button onclick="setMode('sine')" id="btn-sine">æ­£å¼¦æ³¢å‘ç”Ÿå™¨</button>
            <button onclick="setMode('saw')" id="btn-saw">é”¯é½¿æ³¢å‘ç”Ÿå™¨</button>
            <button onclick="setMode('square')" id="btn-square">æ–¹æ³¢å‘ç”Ÿå™¨</button>
        </div>
        
        <div class="control-group">
            <h3>è®¡ç®—å…¬å¼</h3>
            <p style="font-size: 0.8rem; color: #aaa;">
                Vout = -(Vref / 256) * D<br>
                <small>*æ³¨ï¼šå›¾ä¸­OpAmpé…ç½®ä¸ºåå‘æ”¾å¤§å™¨ï¼Œä½†ä¸ºæ–¹ä¾¿æ¼”ç¤ºï¼Œæ³¢å½¢å›¾æ˜¾ç¤ºç»å¯¹å€¼/æ­£å‘å˜åŒ–ã€‚</small>
            </p>
        </div>
    </div>

    <!-- Right Panel: Visualization -->
    <div class="demo-area">
        <div class="overlay-stats">
            V_out: <span id="voutDisplay" style="color: #00ff00; font-size: 1.2em;">2.50</span> V
        </div>
        <canvas id="circuitCanvas"></canvas>
    </div>
</div>

<!-- Bottom Panel: Knowledge -->
<div class="info-panel">
    <h3>ğŸ“š æ ¸å¿ƒçŸ¥è¯†ç‚¹</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <h4>1. ç¡¬ä»¶è¿æ¥åŸç†</h4>
            <ul>
                <li><strong>æ•°æ®æ€»çº¿:</strong> 51å•ç‰‡æœºçš„ <code>P0</code> å£ç›´æ¥è¿æ¥ DAC0832 çš„ <code>DI0-DI7</code> æ•°æ®è¾“å…¥ç«¯ã€‚</li>
                <li><strong>æ§åˆ¶ä¿¡å·:</strong> 
                    <ul>
                        <li><code>CS</code> (ç‰‡é€‰) æ¥ä½ç”µå¹³æˆ–ç”±åœ°å€è¯‘ç æ§åˆ¶ã€‚</li>
                        <li><code>WR1</code> (å†™ä¿¡å·) è¿æ¥å•ç‰‡æœºçš„ <code>WR</code> (P3.6)ã€‚</li>
                    </ul>
                </li>
                <li><strong>ç”µæµè½¬ç”µå‹:</strong> DAC0832 è¾“å‡ºçš„æ˜¯ç”µæµä¿¡å· ($I_{out}$)ï¼Œå¿…é¡»å¤–æ¥è¿ç®—æ”¾å¤§å™¨ï¼ˆå¦‚ LM324, OP07ï¼‰è½¬æ¢ä¸ºç”µå‹ä¿¡å·ã€‚</li>
            </ul>
        </div>
        <div>
            <h4>2. ç¼–ç¨‹æ§åˆ¶é€»è¾‘</h4>
            <ul>
                <li><strong>å•ç¼“å†²æ¨¡å¼:</strong> è®© <code>WR2</code> å’Œ <code>XFER</code> æ¥åœ°ã€‚æ­¤æ—¶åªè¦ <code>WR1</code> æœ‰æ•ˆï¼ŒDAC å¯„å­˜å™¨å°±ä¼šæ›´æ–°ï¼Œè¾“å‡ºç«‹å³å˜åŒ–ã€‚</li>
                <li><strong>ä»£ç ç¤ºä¾‹:</strong> 
                    <br><code>#include &lt;reg52.h&gt;</code><br>
                    <code>#define DAC_PORT P0</code><br>
                    <code>sbit DAC_WR = P3^6;</code><br>
                    <code>void main() { DAC_WR = 0; DAC_PORT = 0x80; } // è¾“å‡ºä¸€åŠç”µå‹</code>
                </li>
                <li><strong>åˆ†è¾¨ç‡:</strong> 8ä½åˆ†è¾¨ç‡ï¼Œå³ $2^8 = 256$ çº§ã€‚æ­¥è¿›ç”µå‹ = $V_{ref} / 256$ã€‚</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // --- Configuration & State ---
    const canvas = document.getElementById('circuitCanvas');
    const ctx = canvas.getContext('2d');
    
    let state = {
        digitalInput: 128, // 0-255
        vref: 5.0,
        mode: 'manual', // manual, sine, saw, square
        time: 0,
        history: new Array(200).fill(0) // For graph
    };

    // DOM Elements
    const els = {
        slider: document.getElementById('inputSlider'),
        digitalDisplay: document.getElementById('digitalVal'),
        vrefSlider: document.getElementById('vrefSlider'),
        vrefDisplay: document.getElementById('vrefVal'),
        bitsContainer: document.getElementById('bits-display'),
        voutDisplay: document.getElementById('voutDisplay')
    };

    // Initialize Bits Display (LEDs)
    for(let i=7; i>=0; i--) {
        let d = document.createElement('div');
        d.className = 'bit-led';
        d.id = 'bit-' + i;
        d.style.width = '15px';
        d.style.height = '15px';
        d.style.borderRadius = '50%';
        d.style.backgroundColor = '#333';
        d.style.border = '1px solid #555';
        d.title = 'Bit ' + i;
        els.bitsContainer.appendChild(d);
    }

    // --- Interaction Handlers ---
    els.slider.addEventListener('input', (e) => {
        state.digitalInput = parseInt(e.target.value);
        setMode('manual');
    });

    els.vrefSlider.addEventListener('input', (e) => {
        state.vref = parseFloat(e.target.value);
    });

    function setMode(mode) {
        state.mode = mode;
        document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + mode).classList.add('active');
        if (mode === 'manual') {
            els.slider.value = state.digitalInput;
        }
    }

    // --- Simulation Logic ---
    function updatePhysics() {
        // Handle Auto Modes
        if (state.mode !== 'manual') {
            state.time += 0.05;
            let val = 0;
            
            if (state.mode === 'sine') {
                // Sine wave mapped to 0-255
                val = 127.5 + 127.5 * Math.sin(state.time);
            } else if (state.mode === 'saw') {
                // Sawtooth
                val = (state.time * 50) % 256;
            } else if (state.mode === 'square') {
                // Square wave
                val = (Math.sin(state.time) > 0) ? 255 : 0;
            }
            
            state.digitalInput = Math.floor(val);
            els.slider.value = state.digitalInput;
        }

        // Calculate Vout
        // Formula: Vout = Vref * (Digital / 256)
        // Note: Real circuit is inverted, here we show magnitude for clarity
        state.vout = (state.vref * (state.digitalInput / 256)).toFixed(2);
        
        // Update History for Graph
        state.history.push(parseFloat(state.vout));
        if (state.history.length > canvas.width / 2) { // Optimize graph width
            state.history.shift();
        }

        // Update DOM UI text
        els.digitalDisplay.innerText = state.digitalInput;
        els.vrefDisplay.innerText = state.vref.toFixed(1);
        els.voutDisplay.innerText = state.vout;

        // Update LEDs
        let bin = state.digitalInput.toString(2).padStart(8, '0');
        for(let i=0; i<8; i++) {
            let bitIdx = 7 - i;
            let led = document.getElementById('bit-' + bitIdx);
            led.style.backgroundColor = (bin[i] === '1') ? '#ff3333' : '#333';
            led.style.boxShadow = (bin[i] === '1') ? '0 0 5px #ff3333' : 'none';
        }
    }

    // --- Drawing Logic ---
    function resizeCanvas() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function drawRoundedRect(x, y, w, h, r, color, text) {
        ctx.fillStyle = color;
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.roundRect(x, y, w, h, r);
        ctx.fill();
        ctx.stroke();
        
        if (text) {
            ctx.fillStyle = "#fff";
            ctx.font = "bold 14px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, x + w/2, y + h/2);
        }
    }

    function drawWire(x1, y1, x2, y2, active) {
        ctx.beginPath();
        ctx.strokeStyle = active ? "#00ff00" : "#555";
        ctx.lineWidth = active ? 3 : 2;
        
        // Simple elbow routing
        ctx.moveTo(x1, y1);
        let midX = (x1 + x2) / 2;
        ctx.lineTo(midX, y1);
        ctx.lineTo(midX, y2);
        ctx.lineTo(x2, y2);
        ctx.stroke();
    }

    function drawSchematic() {
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        
        // 1. Draw MCU (8051)
        const mcuX = 100;
        const mcuY = cy - 50;
        drawRoundedRect(mcuX, mcuY, 120, 150, 10, "#333", "8051 MCU");
        ctx.fillStyle = "#aaa";
        ctx.fillText("P0 Port", mcuX + 100, mcuY + 75);

        // 2. Draw DAC0832
        const dacX = mcuX + 250;
        const dacY = mcuY + 20;
        drawRoundedRect(dacX, dacY, 120, 100, 10, "#444", "DAC0832");
        ctx.fillStyle = "#aaa";
        ctx.fillText("DI0-7", dacX + 20, dacY + 50);

        // 3. Draw OpAmp
        const opX = dacX + 200;
        const opY = dacY + 20;
        // Triangle symbol
        ctx.beginPath();
        ctx.moveTo(opX, opY);
        ctx.lineTo(opX, opY + 60);
        ctx.lineTo(opX + 60, opY + 30);
        ctx.closePath();
        ctx.fillStyle = "#2b2b35";
        ctx.fill();
        ctx.stroke();
        ctx.fillStyle = "#fff";
        ctx.fillText("OpAmp", opX + 20, opY + 30);

        // 4. Wires (Bus)
        // We draw a thick bus line to represent 8 bits
        ctx.beginPath();
        ctx.lineWidth = 8;
        ctx.strokeStyle = "#3d3d4d";
        ctx.moveTo(mcuX + 120, mcuY + 75);
        ctx.lineTo(dacX, dacY + 50);
        ctx.stroke();
        
        // Activity Animation on Bus (Data Flow)
        if (state.digitalInput > 0) {
            ctx.setLineDash([5, 10]);
            ctx.lineDashOffset = -state.time * 20;
            ctx.lineWidth = 4;
            ctx.strokeStyle = "#4caf50";
            ctx.beginPath();
            ctx.moveTo(mcuX + 120, mcuY + 75);
            ctx.lineTo(dacX, dacY + 50);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // 5. Wire DAC to OpAmp (Iout)
        drawWire(dacX + 120, dacY + 30, opX, opY + 20, true);
        
        // 6. Wire OpAmp to Output (Vout)
        ctx.beginPath();
        ctx.strokeStyle = "#00e5ff";
        ctx.lineWidth = 4;
        ctx.moveTo(opX + 60, opY + 30);
        ctx.lineTo(opX + 100, opY + 30);
        ctx.stroke();
        
        // Output Probe
        ctx.beginPath();
        ctx.arc(opX + 100, opY + 30, 5, 0, Math.PI * 2);
        ctx.fillStyle = "#00e5ff";
        ctx.fill();
    }

    function drawOscilloscope() {
        // Draw Graph in the bottom right or top right area
        // Let's put it at the bottom of the canvas area
        const h = 150;
        const w = canvas.width - 40;
        const x = 20;
        const y = canvas.height - h - 20;

        // Background
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        ctx.fillRect(x, y, w, h);
        
        // Grid
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<=4; i++) {
            let ly = y + (h/4)*i;
            ctx.moveTo(x, ly);
            ctx.lineTo(x+w, ly);
        }
        ctx.stroke();

        // Waveform
        ctx.strokeStyle = "#00e5ff";
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        const maxV = 10.0; // Max voltage scale
        
        for (let i = 0; i < state.history.length; i++) {
            // Map i to x
            let px = x + w - (state.history.length - i) * 3; // 3px per point
            if (px < x) continue; // Clip
            
            // Map value to y
            let val = state.history[i];
            let py = y + h - (val / maxV) * h;
            
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        ctx.stroke();

        // Labels
        ctx.fillStyle = "#aaa";
        ctx.font = "10px monospace";
        ctx.fillText("10V", x + 5, y + 10);
        ctx.fillText("0V", x + 5, y + h - 5);
        ctx.fillText("Oscilloscope (Vout)", x + w - 120, y + 15);
    }

    function animate() {
        // Clear
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-color');
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        updatePhysics();
        drawSchematic();
        drawOscilloscope();

        requestAnimationFrame(animate);
    }

    // Start
    animate();

</script>
</body>
</html>