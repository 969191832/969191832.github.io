<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADC0809 é€æ¬¡é€¼è¿‘åŸç†æ¼”ç¤º</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --panel-bg: #2d2d44;
            --accent-color: #4cc9f0;
            --highlight-color: #f72585;
            --success-color: #4caf50;
            --text-color: #e0e0e0;
            --wire-color: #555;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: grid;
            grid-template-rows: 1fr auto;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100% - 160px); /* ç•™å‡ºåº•éƒ¨ç©ºé—´ */
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .controls {
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h2 { margin-top: 0; color: var(--accent-color); font-size: 1.5rem; }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label { font-size: 0.9rem; color: #aaa; }
        
        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .value-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--highlight-color);
            font-size: 1.1rem;
        }

        button {
            background: linear-gradient(135deg, var(--accent-color), #3a86ff);
            border: none;
            padding: 12px;
            color: white;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .status-log {
            margin-top: auto;
            height: 150px;
            background: #111;
            border: 1px solid #444;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-y: auto;
            color: #0f0;
        }

        /* å³ä¾§æ¼”ç¤ºåŒº */
        .demo-stage {
            background-color: var(--panel-bg);
            border-radius: 12px;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }

        /* ç”µå‹å¯¹æ¯”æŸ±çŠ¶å›¾ */
        .voltage-meters {
            display: flex;
            justify-content: center;
            gap: 60px;
            height: 200px;
            margin-bottom: 20px;
            align-items: flex-end;
            border-bottom: 2px solid var(--wire-color);
            padding-bottom: 10px;
            position: relative;
        }

        .meter-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
        }

        .bar-container {
            width: 40px;
            height: 180px;
            background: #111;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            border: 1px solid #555;
        }

        .bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            transition: height 0.3s ease;
        }

        #bar-vin { background-color: var(--success-color); height: 0%; }
        #bar-vdac { background-color: var(--highlight-color); height: 0%; }

        .comparator-symbol {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0; 
            height: 0; 
            border-left: 40px solid #888;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
        }
        .comparator-symbol::after {
            content: "CMP";
            position: absolute;
            left: -35px;
            top: -6px;
            font-size: 10px;
            color: white;
        }

        /* SAR å¯„å­˜å™¨ä½è§†å›¾ */
        .sar-register {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        .bit-box {
            width: 50px;
            height: 70px;
            border: 2px solid var(--wire-color);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #222;
            position: relative;
            transition: all 0.3s;
        }

        .bit-label { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .bit-val { font-size: 1.5rem; font-weight: bold; color: white; }

        .bit-box.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            transform: translateY(-5px);
        }

        .bit-box.kept { border-color: var(--success-color); background: rgba(76, 175, 80, 0.1); }
        .bit-box.dropped { border-color: var(--highlight-color); opacity: 0.6; }

        /* ç»“æœå±•ç¤º */
        .result-overlay {
            margin-top: 30px;
            text-align: center;
            font-size: 1.2rem;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }

        /* åº•éƒ¨çŸ¥è¯†ç‚¹ */
        .knowledge-base {
            background-color: #1a1a24;
            padding: 20px;
            border-top: 3px solid var(--accent-color);
            height: 120px;
            overflow-y: auto;
        }

        .knowledge-base h3 { margin: 0 0 10px 0; color: var(--accent-color); }
        .knowledge-base ul {
            margin: 0;
            padding-left: 20px;
            columns: 2;
            font-size: 0.9rem;
            color: #ccc;
        }
        .knowledge-base li { margin-bottom: 5px; }

        /* åŠ¨ç”»è¿çº¿ç¤ºæ„ (CSS SVG) */
        .wire {
            position: absolute;
            background: var(--wire-color);
            transition: background 0.2s;
        }
        .wire.hot { background: var(--highlight-color); box-shadow: 0 0 8px var(--highlight-color); }

    </style>
</head>
<body>

    <div class="container">
        <!-- å·¦ä¾§æ§åˆ¶ -->
        <div class="controls">
            <h2>âš¡ ADC0809 æ§åˆ¶å°</h2>
            
            <div class="control-group">
                <label>è¾“å…¥ç”µå‹ (Vin): <span id="disp-vin" class="value-display">2.50 V</span></label>
                <input type="range" id="input-vin" min="0" max="5" step="0.01" value="2.50">
            </div>

            <div class="control-group">
                <label>å‚è€ƒç”µå‹ (Vref): <span id="disp-vref" class="value-display">5.00 V</span></label>
                <input type="range" id="input-vref" min="1" max="5" step="0.1" value="5.00">
            </div>

            <div class="control-group">
                <label>æ¼”ç¤ºé€Ÿåº¦ (ms/bit): <span id="disp-speed" class="value-display">800</span></label>
                <input type="range" id="input-speed" min="100" max="2000" step="100" value="800">
            </div>

            <button id="btn-start" onclick="startConversion()">å¼€å§‹è½¬æ¢ (START)</button>
            
            <div class="status-log" id="status-log">
                > ç³»ç»Ÿå°±ç»ª...<br>
                > ç­‰å¾…å¯åŠ¨ä¿¡å·...
            </div>
        </div>

        <!-- å³ä¾§æ¼”ç¤º -->
        <div class="demo-stage">
            <div style="text-align:center; margin-bottom:10px; color:#aaa;">ADC0809 å†…éƒ¨é€»è¾‘è§†å›¾</div>
            
            <!-- ç”µå‹å¯¹æ¯”åŒº -->
            <div class="voltage-meters">
                <div class="meter-box">
                    <div class="bar-container"><div class="bar" id="bar-vin"></div></div>
                    <span>Vin</span>
                    <span id="val-vin-meter" style="font-size:0.8rem">2.50V</span>
                </div>

                <div class="comparator-symbol"></div>

                <div class="meter-box">
                    <div class="bar-container"><div class="bar" id="bar-vdac"></div></div>
                    <span>Vdac</span>
                    <span id="val-vdac-meter" style="font-size:0.8rem">0.00V</span>
                </div>
            </div>

            <!-- SAR å¯„å­˜å™¨ -->
            <div class="sar-register" id="sar-container">
                <!-- ç”±JSç”Ÿæˆ8ä¸ªBitä½ -->
            </div>

            <div class="result-overlay">
                <div>æ•°å­—è¾“å‡º (D7-D0): <span id="res-binary" style="color:var(--accent-color)">00000000</span></div>
                <div>Hex: <span id="res-hex">0x00</span> | Decimal: <span id="res-dec">0</span></div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨çŸ¥è¯†ç‚¹ -->
    <div class="knowledge-base">
        <h3>ğŸ“– æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼šé€æ¬¡é€¼è¿‘å‹ (SAR) ADC</h3>
        <ul>
            <li><strong>åŸºæœ¬åŸç†ï¼š</strong> ç±»ä¼¼äºç”¨å¤©å¹³ç§°é‡ã€‚ä»æœ€é«˜ä½(MSB)å¼€å§‹ï¼Œä¾æ¬¡å‡è®¾æ¯ä¸€ä½ä¸º1ï¼Œæ¯”è¾ƒç”Ÿæˆçš„DACç”µå‹ä¸è¾“å…¥ç”µå‹ã€‚</li>
            <li><strong>åˆ†è¾¨ç‡ï¼š</strong> ADC0809ä¸º8ä½åˆ†è¾¨ç‡ï¼Œå³ $2^8 = 256$ ä¸ªé‡åŒ–ç­‰çº§ã€‚</li>
            <li><strong>é‡åŒ–å…¬å¼ï¼š</strong> $D_{out} = \frac{V_{in}}{V_{ref}} \times 255$ (å–æ•´)ã€‚</li>
            <li><strong>è½¬æ¢æ—¶é—´ï¼š</strong> å–å†³äºæ—¶é’Ÿé¢‘ç‡ï¼ŒSARé€»è¾‘éœ€è¦Nä¸ªæ—¶é’Ÿå‘¨æœŸå®ŒæˆNä½è½¬æ¢ï¼ˆADC0809å…¸å‹çº¦ä¸º100Î¼sï¼‰ã€‚</li>
            <li><strong>ä¸»è¦å¼•è„šï¼š</strong> START(å¯åŠ¨), EOC(è½¬æ¢ç»“æŸ), OE(è¾“å‡ºå…è®¸), CLK(æ—¶é’Ÿ), ALE(åœ°å€é”å­˜)ã€‚</li>
            <li><strong>Vrefå½±å“ï¼š</strong> å‚è€ƒç”µå‹å†³å®šäº†é‡åŒ–èŒƒå›´ã€‚è‹¥ $V_{ref}=5V$ï¼Œåˆ™ $1 \text{ LSB} \approx 19.5mV$ã€‚</li>
        </ul>
    </div>

    <script>
        // åˆå§‹åŒ– DOM å…ƒç´ å¼•ç”¨
        const inputVin = document.getElementById('input-vin');
        const inputVref = document.getElementById('input-vref');
        const inputSpeed = document.getElementById('input-speed');
        const dispVin = document.getElementById('disp-vin');
        const dispVref = document.getElementById('disp-vref');
        const dispSpeed = document.getElementById('disp-speed');
        const barVin = document.getElementById('bar-vin');
        const barVdac = document.getElementById('bar-vdac');
        const sarContainer = document.getElementById('sar-container');
        const logBox = document.getElementById('status-log');
        const btnStart = document.getElementById('btn-start');
        const valVinMeter = document.getElementById('val-vin-meter');
        const valVdacMeter = document.getElementById('val-vdac-meter');

        // çŠ¶æ€å˜é‡
        let currentVin = 2.5;
        let currentVref = 5.0;
        let sarValue = 0; // 0-255
        let isRunning = false;

        // åˆå§‹åŒ– 8ä¸ªBitçš„UI
        function initBits() {
            sarContainer.innerHTML = '';
            for (let i = 7; i >= 0; i--) {
                const bitDiv = document.createElement('div');
                bitDiv.className = 'bit-box';
                bitDiv.id = `bit-${i}`;
                bitDiv.innerHTML = `
                    <span class="bit-label">D${i}</span>
                    <span class="bit-val">0</span>
                `;
                sarContainer.appendChild(bitDiv);
            }
            updateCalculations(0);
        }

        // æ›´æ–°è¾“å…¥æ˜¾ç¤º
        function updateInputs() {
            if(isRunning) return; // è¿è¡Œæ—¶é”å®šUIæ˜¾ç¤ºæ›´æ–°ï¼ˆå®é™…ä¸ŠADCæœ‰é‡‡æ ·ä¿æŒï¼Œè¿™é‡Œç®€åŒ–ï¼‰
            currentVin = parseFloat(inputVin.value);
            currentVref = parseFloat(inputVref.value);
            
            dispVin.textContent = currentVin.toFixed(2) + " V";
            dispVref.textContent = currentVref.toFixed(2) + " V";
            dispSpeed.textContent = inputSpeed.value;

            // æ›´æ–° Vin æŸ±çŠ¶å›¾
            const percent = Math.min((currentVin / currentVref) * 100, 100);
            barVin.style.height = percent + "%";
            valVinMeter.textContent = currentVin.toFixed(2) + "V";
        }

        // äº‹ä»¶ç›‘å¬
        inputVin.addEventListener('input', updateInputs);
        inputVref.addEventListener('input', updateInputs);
        inputSpeed.addEventListener('input', updateInputs);

        // æ—¥å¿—åŠŸèƒ½
        function log(msg) {
            logBox.innerHTML += `> ${msg}<br>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        // æ›´æ–°æ•°å­—ç»“æœæ˜¾ç¤º
        function updateCalculations(val) {
            const binaryStr = val.toString(2).padStart(8, '0');
            document.getElementById('res-binary').textContent = binaryStr;
            document.getElementById('res-hex').textContent = "0x" + val.toString(16).toUpperCase().padStart(2, '0');
            document.getElementById('res-dec').textContent = val;
        }

        // å¼‚æ­¥ç­‰å¾…å‡½æ•°
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        // æ ¸å¿ƒè½¬æ¢é€»è¾‘
        async function startConversion() {
            if (isRunning) return;
            isRunning = true;
            btnStart.disabled = true;
            inputVin.disabled = true;
            inputVref.disabled = true;

            // é”å®šé‡‡æ ·ç”µå‹ (Sample & Hold)
            const sampleVin = parseFloat(inputVin.value);
            const refV = parseFloat(inputVref.value);
            const speed = parseInt(inputSpeed.value);

            log("--- å¼€å§‹è½¬æ¢ ---");
            log(`é‡‡æ · Vin: ${sampleVin.toFixed(2)}V`);
            
            // é‡ç½®SAR
            sarValue = 0;
            initBits(); // é‡ç»˜UI
            updateCalculations(0);
            barVdac.style.height = "0%";
            valVdacMeter.textContent = "0.00V";

            await sleep(speed / 2);

            // é€ä½é€¼è¿‘å¾ªç¯ (Bit 7 -> Bit 0)
            for (let bit = 7; bit >= 0; bit--) {
                const bitEl = document.getElementById(`bit-${bit}`);
                const valEl = bitEl.querySelector('.bit-val');

                // 1. ç½®ä½ï¼šå‡è®¾å½“å‰ä½ä¸º 1
                log(`[Step D${bit}] å°è¯•ç½® 1...`);
                bitEl.classList.add('active');
                valEl.textContent = "1";
                
                // è®¡ç®—å½“å‰çš„ä¸´æ—¶ Vdac
                // å½“å‰SARå€¼ = å·²ç¡®å®šçš„é«˜ä½ + å½“å‰å°è¯•ä½(1)
                let tempSar = sarValue | (1 << bit);
                let vDac = (tempSar / 255) * refV; // ADC0809 æ˜¯256çº§ï¼Œä½†åœ¨æ•°å­¦æ¨¡å‹ä¸­æœ€å¤§å€¼å¯¹åº”Vrefé€šå¸¸å¤„ç†ä¸º255æˆ–256ï¼Œè¿™é‡Œç”¨255å½’ä¸€åŒ–
                
                // æ›´æ–° DAC UI
                barVdac.style.height = Math.min((vDac / refV) * 100, 100) + "%";
                valVdacMeter.textContent = vDac.toFixed(2) + "V";
                updateCalculations(tempSar);

                await sleep(speed);

                // 2. æ¯”è¾ƒï¼šVin >= Vdac ?
                if (sampleVin >= vDac) {
                    // å¤Ÿå¤§ï¼Œä¿ç•™è¯¥ä½
                    log(`Vin (${sampleVin.toFixed(2)}) >= Vdac (${vDac.toFixed(2)}) -> ä¿ç•™ 1`);
                    sarValue = tempSar; // æ›´æ–°ç¡®å®šå€¼
                    bitEl.classList.remove('active');
                    bitEl.classList.add('kept');
                } else {
                    // å¤ªå¤§äº†ï¼Œè¯¥ä½æ¸…é›¶
                    log(`Vin (${sampleVin.toFixed(2)}) < Vdac (${vDac.toFixed(2)}) -> æ¢å¤ 0`);
                    valEl.textContent = "0";
                    bitEl.classList.remove('active');
                    bitEl.classList.add('dropped');
                    
                    // æ¢å¤æ˜¾ç¤ºçš„Vdacç”µå‹åˆ°ä¹‹å‰çš„çŠ¶æ€ (ä¸ºäº†è§†è§‰è¿è´¯æ€§)
                    let prevVdac = (sarValue / 255) * refV;
                    barVdac.style.height = Math.min((prevVdac / refV) * 100, 100) + "%";
                    valVdacMeter.textContent = prevVdac.toFixed(2) + "V";
                    updateCalculations(sarValue);
                }
                
                await sleep(speed / 2);
            }

            // ç»“æŸ
            log(`--- è½¬æ¢ç»“æŸ (EOC) ---`);
            log(`æœ€ç»ˆç»“æœ: ${sarValue} (0x${sarValue.toString(16).toUpperCase()})`);
            
            isRunning = false;
            btnStart.disabled = false;
            inputVin.disabled = false;
            inputVref.disabled = false;
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        initBits();
        updateInputs();

    </script>
</body>
</html>